<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var vmlCore = require(&quot;./core&quot;);

var dataUtil = require(&quot;../core/utils/dataStructureUtil&quot;);

var each = dataUtil.each;

<span id='zrender-svg-VMLPainter'>/**
</span> * @class zrender.svg.VMLPainter
 * 
 * VMLPainter.
 * 
 * @docauthor 大漠穷秋 damoqiongqiu@126.com
 */

<span id='zrender-svg-VMLPainter-method-constructor'>/**
</span> * @method constructor VMLPainter
 * @param {*} root 
 * @param {*} storage 
 */
function VMLPainter(root, storage) {
  vmlCore.initVML();
  this.root = root;
  this.storage = storage;
  var vmlViewport = document.createElement(&#39;div&#39;);
  var vmlRoot = document.createElement(&#39;div&#39;);
  vmlViewport.style.cssText = &#39;display:inline-block;overflow:hidden;position:relative;width:300px;height:150px;&#39;;
  vmlRoot.style.cssText = &#39;position:absolute;left:0;top:0;&#39;;
  root.appendChild(vmlViewport);
  this._vmlRoot = vmlRoot;
  this._vmlViewport = vmlViewport;
  this.resize(); // Modify storage

  var oldDelFromStorage = storage.delFromStorage;
  var oldAddToStorage = storage.addToStorage;

  storage.delFromStorage = function (el) {
    oldDelFromStorage.call(storage, el);

    if (el) {
      el.onRemove &amp;&amp; el.onRemove(vmlRoot);
    }
  };

  storage.addToStorage = function (el) {
    // Displayable already has a vml node
    el.onAdd &amp;&amp; el.onAdd(vmlRoot);
    oldAddToStorage.call(storage, el);
  };

  this._firstPaint = true;
}

VMLPainter.prototype = {
  constructor: VMLPainter,

<span id='zrender-svg-VMLPainter-method-getType'>  /**
</span>   * @method getType
   */
  getType: function getType() {
    return &#39;vml&#39;;
  },

<span id='zrender-svg-VMLPainter-method-getViewportRoot'>  /**
</span>   * @method getViewportRoot
   * @return {HTMLDivElement}
   */
  getViewportRoot: function getViewportRoot() {
    return this._vmlViewport;
  },

<span id='zrender-svg-VMLPainter-method-getViewportRootOffset'>  /**
</span>   * @method getViewportRootOffset
   */
  getViewportRootOffset: function getViewportRootOffset() {
    var viewportRoot = this.getViewportRoot();

    if (viewportRoot) {
      return {
        offsetLeft: viewportRoot.offsetLeft || 0,
        offsetTop: viewportRoot.offsetTop || 0
      };
    }
  },

<span id='zrender-svg-VMLPainter-method-refresh'>  /**
</span>   * @method refresh 刷新
   */
  refresh: function refresh() {
    var list = this.storage.getDisplayList(true, true);

    this._paintList(list);
  },

<span id='zrender-svg-VMLPainter-method-_paintList'>  /**
</span>   * @private
   * @method _paintList
   * @param {*} list 
   */
  _paintList: function _paintList(list) {
    var vmlRoot = this._vmlRoot;

    for (var i = 0; i &lt; list.length; i++) {
      var el = list[i];

      if (el.invisible || el.ignore) {
        if (!el.__alreadyNotVisible) {
          el.onRemove(vmlRoot);
        } // Set as already invisible


        el.__alreadyNotVisible = true;
      } else {
        if (el.__alreadyNotVisible) {
          el.onAdd(vmlRoot);
        }

        el.__alreadyNotVisible = false;

        if (el.__dirty) {
          el.beforeBrush &amp;&amp; el.beforeBrush();
          (el.brushVML || el.brush).call(el, vmlRoot);
          el.afterBrush &amp;&amp; el.afterBrush();
        }
      }

      el.__dirty = false;
    }

    if (this._firstPaint) {
      // Detached from document at first time
      // to avoid page refreshing too many times
      // FIXME 如果每次都先 removeChild 可能会导致一些填充和描边的效果改变
      this._vmlViewport.appendChild(vmlRoot);

      this._firstPaint = false;
    }
  },

<span id='zrender-svg-VMLPainter-method-resize'>  /**
</span>   * @method resize
   * @param {Number} width 
   * @param {Number} height 
   */
  resize: function resize(width, height) {
    width = width == null ? this._getWidth() : width;
    height = height == null ? this._getHeight() : height;

    if (this._width !== width || this._height !== height) {
      this._width = width;
      this._height = height;
      var vmlViewportStyle = this._vmlViewport.style;
      vmlViewportStyle.width = width + &#39;px&#39;;
      vmlViewportStyle.height = height + &#39;px&#39;;
    }
  },

<span id='zrender-svg-VMLPainter-method-dispose'>  /**
</span>   * @method dispose
   */
  dispose: function dispose() {
    this.root.innerHTML = &#39;&#39;;
    this._vmlRoot = this._vmlViewport = this.storage = null;
  },

<span id='zrender-svg-VMLPainter-method-getWidth'>  /**
</span>   * @method getWidth
   */
  getWidth: function getWidth() {
    return this._width;
  },

<span id='zrender-svg-VMLPainter-method-getHeight'>  /**
</span>   * @method getHeight
   */
  getHeight: function getHeight() {
    return this._height;
  },

<span id='zrender-svg-VMLPainter-method-clear'>  /**
</span>   * @method clear
   */
  clear: function clear() {
    if (this._vmlViewport) {
      this.root.removeChild(this._vmlViewport);
    }
  },

<span id='zrender-svg-VMLPainter-method-_getWidth'>  /**
</span>   * @private
   * @method _getWidth
   */
  _getWidth: function _getWidth() {
    var root = this.root;
    var stl = root.currentStyle;
    return (root.clientWidth || dataUtil.parseInt10(stl.width)) - dataUtil.parseInt10(stl.paddingLeft) - dataUtil.parseInt10(stl.paddingRight) | 0;
  },

<span id='zrender-svg-VMLPainter-method-_getHeight'>  /**
</span>   * @private
   * @method _getHeight
   */
  _getHeight: function _getHeight() {
    var root = this.root;
    var stl = root.currentStyle;
    return (root.clientHeight || dataUtil.parseInt10(stl.height)) - dataUtil.parseInt10(stl.paddingTop) - dataUtil.parseInt10(stl.paddingBottom) | 0;
  }
}; // Not supported methods

function createMethodNotSupport(method) {
  return function () {
    console.log(&#39;In IE8.0 VML mode painter not support method &quot;&#39; + method + &#39;&quot;&#39;);
  };
} // Unsupported methods


[&#39;getLayer&#39;, &#39;insertLayer&#39;, &#39;eachLayer&#39;, &#39;eachBuiltinLayer&#39;, &#39;eachOtherLayer&#39;, &#39;getLayers&#39;, &#39;modLayer&#39;, &#39;delLayer&#39;, &#39;clearLayer&#39;, &#39;toDataURL&#39;, &#39;pathToImage&#39;].forEach(function (name, index) {
  VMLPainter.prototype[name] = createMethodNotSupport(name);
});
var _default = VMLPainter;
module.exports = _default;</pre>
</body>
</html>
